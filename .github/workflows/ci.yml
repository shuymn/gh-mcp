name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  actions: read  # Required for octocov to read artifacts
  pull-requests: write  # Required for octocov to comment on PRs

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
    - name: Check if tagpr branch
      id: check-branch
      run: |
        if [[ "${{ github.head_ref || github.ref_name }}" == tagpr-from-v* ]]; then
          echo "skip=true" >> $GITHUB_OUTPUT
        else
          echo "skip=false" >> $GITHUB_OUTPUT
        fi

    - name: Checkout code
      if: steps.check-branch.outputs.skip != 'true'
      uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

    - name: Set up Go
      if: steps.check-branch.outputs.skip != 'true'
      uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
      with:
        go-version: stable
        cache: true

    - name: Set golangci-lint version
      id: set-golangci-lint-version
      if: steps.check-branch.outputs.skip != 'true'
      run: echo "version=$(yq '.vars.GOLANGCI_LINT_VERSION' Taskfile.yml)" >> $GITHUB_OUTPUT

    - name: Run golangci-lint
      if: steps.check-branch.outputs.skip != 'true'
      uses: golangci/golangci-lint-action@1e7e51e771db61008b38414a730f564565cf7c20 # v9.2.0
      with:
        version: ${{ steps.set-golangci-lint-version.outputs.version }}
        args: --timeout=5m

  test:
    name: Test
    needs: lint
    runs-on: ubuntu-latest

    steps:
    - name: Check if tagpr branch
      id: check-branch
      run: |
        if [[ "${{ github.head_ref || github.ref_name }}" == tagpr-from-v* ]]; then
          echo "skip=true" >> $GITHUB_OUTPUT
        else
          echo "skip=false" >> $GITHUB_OUTPUT
        fi

    - name: Checkout code
      if: steps.check-branch.outputs.skip != 'true'
      uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

    - name: Set up Go
      if: steps.check-branch.outputs.skip != 'true'
      uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
      with:
        go-version: stable
        cache: true

    - name: Install Task
      uses: arduino/setup-task@b91d5d2c96a56797b48ac1e0e89220bf64044611 # v2.0.0
      with:
        version: 3.x
        repo-token: ${{ secrets.GITHUB_TOKEN }}

    - name: Download dependencies
      if: steps.check-branch.outputs.skip != 'true'
      run: go mod download

    - name: Verify dependencies
      if: steps.check-branch.outputs.skip != 'true'
      run: task deps-verify

    - name: Run tests
      if: steps.check-branch.outputs.skip != 'true'
      run: task test

    - name: Run tests with coverage
      if: steps.check-branch.outputs.skip != 'true'
      run: go test -race -coverprofile=coverage.out ./...

    - uses: k1LoW/octocov-action@73d561f65d59e66899ed5c87e4621a913b5d5c20 # v1.5.0
      if: steps.check-branch.outputs.skip != 'true'

  build:
    name: Build
    needs: test
    runs-on: ubuntu-latest

    steps:
    - name: Check if tagpr branch
      id: check-branch
      run: |
        if [[ "${{ github.head_ref || github.ref_name }}" == tagpr-from-v* ]]; then
          echo "skip=true" >> $GITHUB_OUTPUT
        else
          echo "skip=false" >> $GITHUB_OUTPUT
        fi

    - name: Checkout code
      if: steps.check-branch.outputs.skip != 'true'
      uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

    - name: Set up Go
      if: steps.check-branch.outputs.skip != 'true'
      uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
      with:
        go-version: stable
        cache: true

    - name: Install Task
      uses: arduino/setup-task@b91d5d2c96a56797b48ac1e0e89220bf64044611 # v2.0.0
      with:
        version: 3.x
        repo-token: ${{ secrets.GITHUB_TOKEN }}

    - name: Build binary
      if: steps.check-branch.outputs.skip != 'true'
      run: task build

    - name: Test binary exists and is executable
      if: steps.check-branch.outputs.skip != 'true'
      run: |
        test -f gh-mcp
        test -x gh-mcp
        ./gh-mcp --version || true

    - name: Upload artifact
      if: steps.check-branch.outputs.skip != 'true'
      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
      with:
        name: gh-mcp-linux-amd64
        path: gh-mcp
        retention-days: 7
